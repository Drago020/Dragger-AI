<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dragger AI Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#4f46e5" />
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- FIX 3: Markdown renderer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-thumb { background: #555; border-radius: 6px; }

    .app-bg {
      background-image: url("wallpaper.jpeg");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }
    .app-overlay { background: rgba(0,0,0,0.65); }
    .glass {
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border: 1px solid rgba(255,255,255,0.12);
    }

    /* Typing indicator dots */
    .dot-flashing {
      display: inline-flex;
      gap: 4px;
      align-items: center;
      padding: 4px 0;
    }
    .dot-flashing span {
      width: 7px; height: 7px;
      border-radius: 50%;
      background: #a5b4fc;
      animation: blink 1.2s infinite;
    }
    .dot-flashing span:nth-child(2) { animation-delay: 0.2s; }
    .dot-flashing span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes blink {
      0%, 80%, 100% { opacity: 0.2; transform: scale(0.8); }
      40% { opacity: 1; transform: scale(1); }
    }

    /* Active chat highlight */
    .chat-item.active { background: rgba(99,102,241,0.35); }

    /* FIX 3: Markdown styles inside AI bubbles */
    .ai-bubble p { margin-bottom: 0.5em; }
    .ai-bubble p:last-child { margin-bottom: 0; }
    .ai-bubble ul, .ai-bubble ol { padding-left: 1.25em; margin-bottom: 0.5em; }
    .ai-bubble li { margin-bottom: 0.2em; }
    .ai-bubble code {
      background: rgba(255,255,255,0.15);
      padding: 0.1em 0.4em;
      border-radius: 4px;
      font-size: 0.85em;
      font-family: monospace;
    }
    .ai-bubble pre {
      background: rgba(0,0,0,0.35);
      border-radius: 8px;
      padding: 0.75em 1em;
      overflow-x: auto;
      margin: 0.5em 0;
    }
    .ai-bubble pre code {
      background: none;
      padding: 0;
      font-size: 0.82em;
    }
    .ai-bubble strong { color: #c7d2fe; }
    .ai-bubble h1, .ai-bubble h2, .ai-bubble h3 {
      font-weight: 700;
      margin: 0.5em 0 0.25em;
      color: #e0e7ff;
    }

    /* Model picker */
    .model-group-label {
      padding: 6px 10px 2px;
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #818cf8;
      font-weight: 700;
    }
    .model-option {
      display: flex;
      flex-direction: column;
      padding: 7px 12px;
      cursor: pointer;
      transition: background 0.12s;
      border-left: 2px solid transparent;
    }
    .model-option:hover { background: rgba(99,102,241,0.18); }
    .model-option.selected {
      background: rgba(99,102,241,0.28);
      border-left-color: #818cf8;
    }
    .model-option .model-name { font-weight: 500; color: #e0e7ff; }
    .model-option .model-id   { font-size: 0.7rem; color: #9ca3af; font-family: monospace; }
    .model-option .model-tag  {
      font-size: 0.6rem; padding: 1px 5px; border-radius: 99px;
      display: inline-block; margin-top: 2px; font-weight: 600;
    }
    .tag-free    { background: rgba(34,197,94,0.2);  color: #86efac; }
    .tag-fast    { background: rgba(251,191,36,0.2); color: #fde68a; }
    .tag-powerful{ background: rgba(167,139,250,0.2);color: #c4b5fd; }

    /* Delete button on chat items */
    .chat-item-wrap:hover .delete-chat-btn { opacity: 1; }
    .delete-chat-btn {
      opacity: 0;
      transition: opacity 0.15s;
    }
  </style>
</head>

<body class="text-gray-100 app-bg">
<div class="h-[100dvh] flex overflow-x-hidden app-overlay">

  <!-- Sidebar -->
  <aside id="sidebar"
    class="fixed md:static top-0 left-0 h-full w-64 glass flex flex-col z-40
           -translate-x-full md:translate-x-0 transition-transform duration-300">

    <div class="p-4 border-b border-white/10 flex justify-between items-center">
      <span class="font-bold">Dragger AI</span>
      <button id="newChatBtn" title="New chat"
        class="bg-indigo-600 hover:bg-indigo-500 px-2 py-1 rounded transition-colors">+</button>
    </div>

    <div id="chatList" class="flex-1 overflow-y-auto p-2 space-y-1"></div>

    <!-- API Credits -->
    <div class="mx-3 mb-2 rounded-lg border border-white/10 bg-white/5 px-3 py-2">
      <div class="flex items-center justify-between mb-1">
        <span class="text-xs text-gray-400">OpenRouter Credits</span>
        <button id="refreshCreditsBtn" title="Refresh"
          class="text-gray-400 hover:text-indigo-300 text-xs transition-colors">â†»</button>
      </div>
      <div id="creditsDisplay" class="text-sm font-mono font-semibold text-indigo-300">â€”</div>
      <div id="creditsSubtext" class="text-xs text-gray-500 mt-0.5">Set API key to load</div>
    </div>

    <!-- About / Credits -->
    <details class="mx-3 mb-2 rounded-lg border border-white/10 bg-white/5 text-xs">
      <summary class="px-3 py-2 cursor-pointer text-gray-400 hover:text-gray-200 transition-colors select-none">
        â„¹ About &amp; Credits
      </summary>
      <div class="px-3 pb-3 pt-1 space-y-2 text-gray-400">
        <div>
          <span class="text-indigo-300 font-semibold">Dragger AI</span>
          <span class="ml-1 text-gray-500">v1.0</span>
        </div>
        <p class="leading-relaxed">A lightweight AI chat PWA powered by <a href="https://openrouter.ai" target="_blank" class="text-indigo-300 hover:underline">OpenRouter</a>, giving you access to dozens of AI models in one place.</p>
        <div class="border-t border-white/10 pt-2 space-y-1">
          <div class="flex justify-between">
            <span>Made by</span>
            <span class="text-gray-200 font-medium">Drago Warior</span>
          </div>
          <div class="flex justify-between">
            <span>UI</span>
            <span class="text-gray-200">Tailwind CSS</span>
          </div>
          <div class="flex justify-between">
            <span>Markdown</span>
            <span class="text-gray-200">marked.js</span>
          </div>
          <div class="flex justify-between">
            <span>Models via</span>
            <span class="text-gray-200">OpenRouter API</span>
          </div>
        </div>
        <p class="text-gray-500 leading-relaxed">Your API key and chats are stored locally on your device only.</p>
      </div>
    </details>

    <button id="settingsBtn" 
      class="mx-3 mb-2 px-3 py-2 rounded-lg border border-white/10 bg-white/5 text-xs cursor-pointer text-gray-400 hover:text-gray-200 transition-colors select-none"> 
      âš™ Settings
    </button>
  </aside>

  <!-- Main -->
  <main class="flex-1 flex flex-col min-h-0">

    <!-- Mobile header -->
    <div class="md:hidden flex items-center justify-between px-4 py-3 border-b border-white/10 glass">
      <button id="menuBtn" class="text-xl">â˜°</button>
      <span class="font-bold">Dragger AI</span>
      <button id="settingsBtnMobile">âš™</button>
    </div>

    <!-- Chat -->
    <div id="chatArea" class="flex-1 overflow-y-auto p-4 space-y-4"></div>

    <!-- Input -->
    <div class="border-t border-white/10 p-3 flex gap-2 glass">
      <input
        id="userInput"
        type="text"
        placeholder="Ask anything..."
        maxlength="4000"
        class="flex-1 bg-white/10 rounded-xl px-4 py-2 focus:outline-none focus:ring-1 focus:ring-indigo-400"
        autocomplete="off"
      />
      <button id="sendBtn"
        class="bg-indigo-600 hover:bg-indigo-500 disabled:opacity-40 disabled:cursor-not-allowed
               px-4 py-2 rounded-xl font-semibold transition-colors">
        Send
      </button>
    </div>
  </main>

  <!-- Settings Modal -->
  <div id="settingsModal"
    class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
    <div class="glass w-96 max-w-[90%] rounded-lg p-6 space-y-4" id="settingsPanel">
      <h2 class="text-xl font-bold">Settings</h2>

      <div>
        <label class="text-sm text-gray-300">OpenRouter API Key</label>
        <input id="apiKeyInput" type="password"
          class="w-full mt-1 bg-white/10 rounded px-3 py-2 focus:outline-none focus:ring-1 focus:ring-indigo-400" />
      </div>

      <div>
        <label class="text-sm text-gray-300">AI Model</label>

        <!-- Search box -->
        <input id="modelSearch" type="text" placeholder="Search models..."
          class="w-full mt-1 mb-2 bg-white/10 rounded px-3 py-2 focus:outline-none focus:ring-1 focus:ring-indigo-400 text-sm" />

        <!-- Model list -->
        <div id="modelList"
          class="w-full bg-black/30 rounded border border-white/10 max-h-48 overflow-y-auto text-sm">
        </div>

        <!-- Currently selected display -->
        <div class="mt-2 flex items-center gap-2">
          <span class="text-xs text-gray-400">Selected:</span>
          <span id="selectedModelDisplay" class="text-xs text-indigo-300 font-mono truncate"></span>
        </div>

        <!-- Custom model input -->
        <details class="mt-2">
          <summary class="text-xs text-gray-400 cursor-pointer hover:text-gray-200 transition-colors">
            Use a custom model ID instead
          </summary>
          <input id="modelInput" type="text"
            placeholder="e.g. mistralai/mistral-7b-instruct"
            class="w-full mt-1 bg-white/10 rounded px-3 py-2 focus:outline-none focus:ring-1 focus:ring-indigo-400 text-sm" />
        </details>
      </div>

      <div class="flex justify-end gap-2">
        <button id="closeSettings"
          class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded transition-colors">Cancel</button>
        <button id="saveSettings"
          class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded transition-colors">Save</button>
      </div>
    </div>
  </div>

</div>

<script>
/* ========= MARKED CONFIG ========= */
marked.setOptions({ breaks: true, gfm: true });

/* ========= DOM ========= */
const chatArea      = document.getElementById("chatArea");
const chatList      = document.getElementById("chatList");
const userInput     = document.getElementById("userInput");
const sendBtn       = document.getElementById("sendBtn");
const menuBtn       = document.getElementById("menuBtn");
const sidebar       = document.getElementById("sidebar");
const settingsModal = document.getElementById("settingsModal");
const settingsPanel = document.getElementById("settingsPanel");
const apiKeyInput   = document.getElementById("apiKeyInput");

/* ========= STATE ========= */
let chats        = JSON.parse(localStorage.getItem("chats") || "{}");
let activeChatId = localStorage.getItem("activeChatId");
let isStreaming   = false;

/* ========= INIT ========= */
if (!activeChatId || !chats[activeChatId]) {
  createNewChat();
} else {
  renderChats();
  renderMessages();
}

/* ========= HELPERS ========= */
function saveChats() {
  localStorage.setItem("chats", JSON.stringify(chats));
  localStorage.setItem("activeChatId", activeChatId);
}

/** Safely escape user content to prevent XSS */
function escapeHtml(text) {
  return text
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;")
    .replace(/\n/g, "<br>");
}

function closeSidebar() {
  if (window.innerWidth < 768) sidebar.classList.add("-translate-x-full");
}

/* ========= CHAT MANAGEMENT ========= */
function createNewChat() {
  const id = Date.now().toString();
  chats[id] = [{ role: "assistant", content: "ðŸ‘‹ Welcome! Ask me anything." }];
  activeChatId = id;
  saveChats();
  renderChats();
  renderMessages();
}

function switchChat(id) {
  activeChatId = id;
  saveChats();
  renderChats();
  renderMessages();
  closeSidebar();
}

// FIX 4: Delete a chat
function deleteChat(id) {
  delete chats[id];
  // If we deleted the active chat, switch to another or create new
  if (activeChatId === id) {
    const remaining = Object.keys(chats);
    if (remaining.length > 0) {
      activeChatId = remaining[remaining.length - 1];
    } else {
      createNewChat();
      return;
    }
  }
  saveChats();
  renderChats();
  renderMessages();
}

function renderChats() {
  chatList.innerHTML = "";
  const ids = Object.keys(chats).sort((a, b) => b - a);
  ids.forEach(id => {
    // FIX 4: Wrap in a relative div for delete button
    const wrap = document.createElement("div");
    wrap.className = "chat-item-wrap relative flex items-center group";

    const btn = document.createElement("button");
    btn.className = "chat-item flex-1 text-left px-3 py-2 rounded hover:bg-white/10 text-sm truncate transition-colors pr-8" +
                    (id === activeChatId ? " active" : "");

    const firstUser = chats[id].find(m => m.role === "user");
    btn.textContent = firstUser
      ? firstUser.content.slice(0, 30) + (firstUser.content.length > 30 ? "â€¦" : "")
      : "New Chat";
    btn.title = btn.textContent;
    btn.onclick = () => switchChat(id);

    // FIX 4: Delete button
    const delBtn = document.createElement("button");
    delBtn.className = "delete-chat-btn absolute right-2 text-gray-400 hover:text-red-400 text-xs px-1 py-0.5 rounded transition-colors";
    delBtn.textContent = "âœ•";
    delBtn.title = "Delete chat";
    delBtn.onclick = (e) => {
      e.stopPropagation();
      deleteChat(id);
    };

    wrap.appendChild(btn);
    wrap.appendChild(delBtn);
    chatList.appendChild(wrap);
  });
}

/* ========= MESSAGES ========= */
function renderMessages() {
  chatArea.innerHTML = "";
  chats[activeChatId].forEach(msg => appendMessageEl(msg.role, msg.content));
  chatArea.scrollTop = chatArea.scrollHeight;
}

function appendMessageEl(role, content) {
  const wrap = document.createElement("div");
  wrap.className = role === "user" ? "text-right" : "text-left";

  const bubble = document.createElement("div");
  bubble.className = `inline-block max-w-[85%] px-4 py-2 rounded-2xl glass text-sm leading-relaxed ${
    role === "user" ? "bg-indigo-500/40" : "bg-white/10 ai-bubble"
  }`;

  // FIX 3: Render markdown for AI, escape HTML for user
  bubble.innerHTML = role === "assistant"
    ? marked.parse(content)
    : escapeHtml(content);

  wrap.appendChild(bubble);
  chatArea.appendChild(wrap);
  return wrap;
}

function showTypingIndicator() {
  const wrap = document.createElement("div");
  wrap.className = "text-left";
  wrap.id = "typingIndicator";
  wrap.innerHTML = `
    <div class="inline-block px-4 py-2 rounded-2xl glass bg-white/10">
      <div class="dot-flashing"><span></span><span></span><span></span></div>
    </div>`;
  chatArea.appendChild(wrap);
  chatArea.scrollTop = chatArea.scrollHeight;
}

function removeTypingIndicator() {
  document.getElementById("typingIndicator")?.remove();
}

/* ========= STREAMING TYPE EFFECT ========= */
async function typeAssistantMessage(text) {
  const msg = { role: "assistant", content: "" };
  chats[activeChatId].push(msg);

  const wrap = document.createElement("div");
  wrap.className = "text-left";
  const bubble = document.createElement("div");
  // FIX 3: add ai-bubble class for markdown styles
  bubble.className = "inline-block max-w-[85%] px-4 py-2 rounded-2xl glass bg-white/10 text-sm leading-relaxed ai-bubble";
  wrap.appendChild(bubble);
  chatArea.appendChild(wrap);

  for (const char of text) {
    msg.content += char;
    // FIX 3: Render markdown while typing
    bubble.innerHTML = marked.parse(msg.content);
    chatArea.scrollTop = chatArea.scrollHeight;
    await new Promise(r => setTimeout(r, 14));
  }

  saveChats();
}

/* ========= SEND ========= */
function setInputLocked(locked) {
  isStreaming = locked;
  sendBtn.disabled = locked;
  userInput.disabled = locked;
}

async function sendMessage() {
  const content = userInput.value.trim();
  if (!content || isStreaming) return;

  userInput.value = "";
  setInputLocked(true);
  closeSidebar();

  chats[activeChatId].push({ role: "user", content });
  appendMessageEl("user", content);
  chatArea.scrollTop = chatArea.scrollHeight;
  renderChats();
  saveChats();

  const apiKey = localStorage.getItem("apiKey");
  const model  = localStorage.getItem("model") || "google/gemini-pro";

  if (!apiKey) {
    await typeAssistantMessage("âš ï¸ Please set your OpenRouter API key in âš™ Settings.");
    setInputLocked(false);
    return;
  }

  showTypingIndicator();

  try {
    const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + apiKey
      },
      body: JSON.stringify({
        model,
        messages: chats[activeChatId].map(({ role, content }) => ({ role, content }))
      })
    });

    removeTypingIndicator();

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      const msg = err?.error?.message || `API error ${res.status}`;
      await typeAssistantMessage(`âš ï¸ ${msg}`);
    } else {
      const data = await res.json();
      const reply = data.choices?.[0]?.message?.content;
      await typeAssistantMessage(reply || "âš ï¸ No response from model.");
    }
  } catch (err) {
    removeTypingIndicator();
    await typeAssistantMessage(`âš ï¸ Network error: ${err.message}`);
  } finally {
    setInputLocked(false);
    userInput.focus();
  }
}

/* ========= UI EVENTS ========= */
menuBtn.addEventListener("click", () => sidebar.classList.toggle("-translate-x-full"));

document.getElementById("newChatBtn").onclick = () => {
  createNewChat();
  closeSidebar();
};

userInput.addEventListener("keydown", e => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});
sendBtn.addEventListener("click", sendMessage);

/* ========= MODEL PICKER ========= */
const MODELS = [
  {
    group: "Google",
    models: [
      { name: "Gemini 2.0 Flash",      id: "google/gemini-2.0-flash-001",          tags: ["fast"] },
      { name: "Gemini 2.5 Pro",         id: "google/gemini-2.5-pro-preview-03-25",  tags: ["powerful"] },
      { name: "Gemini Flash 1.5 8B",    id: "google/gemini-flash-1.5-8b",           tags: ["free","fast"] },
    ]
  },
  {
    group: "OpenAI",
    models: [
      { name: "GPT-4o",                 id: "openai/gpt-4o",                        tags: ["powerful"] },
      { name: "GPT-4o Mini",            id: "openai/gpt-4o-mini",                   tags: ["fast"] },
      { name: "o3 Mini",                id: "openai/o3-mini",                       tags: ["powerful"] },
    ]
  },
  {
    group: "Anthropic",
    models: [
      { name: "Claude 3.5 Sonnet",      id: "anthropic/claude-3-5-sonnet",          tags: ["powerful"] },
      { name: "Claude 3.5 Haiku",       id: "anthropic/claude-3-5-haiku",           tags: ["fast"] },
      { name: "Claude 3 Opus",          id: "anthropic/claude-3-opus",              tags: ["powerful"] },
    ]
  },
  {
    group: "Meta",
    models: [
      { name: "Llama 3.3 70B",          id: "meta-llama/llama-3.3-70b-instruct",    tags: ["free","fast"] },
      { name: "Llama 3.1 8B",           id: "meta-llama/llama-3.1-8b-instruct",     tags: ["free","fast"] },
      { name: "Llama 4 Maverick",       id: "meta-llama/llama-4-maverick",          tags: ["powerful"] },
    ]
  },
  {
    group: "Mistral",
    models: [
      { name: "Mistral 7B Instruct",    id: "mistralai/mistral-7b-instruct",        tags: ["free","fast"] },
      { name: "Mixtral 8x7B",           id: "mistralai/mixtral-8x7b-instruct",      tags: ["fast"] },
      { name: "Mistral Large",          id: "mistralai/mistral-large",              tags: ["powerful"] },
    ]
  },
  {
    group: "DeepSeek",
    models: [
      { name: "DeepSeek Chat V3",       id: "deepseek/deepseek-chat-v3-0324",       tags: ["powerful"] },
      { name: "DeepSeek R1",            id: "deepseek/deepseek-r1",                 tags: ["powerful"] },
      { name: "DeepSeek R1 (free)",     id: "deepseek/deepseek-r1:free",            tags: ["free"] },
    ]
  },
  {
    group: "xAI",
    models: [
      { name: "Grok 3",                 id: "x-ai/grok-3",                          tags: ["powerful"] },
      { name: "Grok 3 Mini",            id: "x-ai/grok-3-mini",                     tags: ["fast"] },
    ]
  },
];

let selectedModel = localStorage.getItem("model") || "google/gemini-2.0-flash-001";

function buildModelList(filter = "") {
  const list = document.getElementById("modelList");
  list.innerHTML = "";
  const q = filter.toLowerCase();

  MODELS.forEach(group => {
    const filtered = group.models.filter(m =>
      m.name.toLowerCase().includes(q) || m.id.toLowerCase().includes(q)
    );
    if (!filtered.length) return;

    const label = document.createElement("div");
    label.className = "model-group-label";
    label.textContent = group.group;
    list.appendChild(label);

    filtered.forEach(m => {
      const el = document.createElement("div");
      el.className = "model-option" + (m.id === selectedModel ? " selected" : "");
      el.innerHTML = `
        <span class="model-name">${m.name}</span>
        <span class="model-id">${m.id}</span>
        <span>${m.tags.map(t => `<span class="model-tag tag-${t}">${t}</span>`).join(" ")}</span>
      `;
      el.onclick = () => {
        selectedModel = m.id;
        document.getElementById("modelInput").value = "";
        document.getElementById("selectedModelDisplay").textContent = m.id;
        buildModelList(document.getElementById("modelSearch").value);
      };
      list.appendChild(el);
    });
  });

  if (!list.children.length) {
    list.innerHTML = `<div class="p-3 text-sm text-gray-400">No models found. Use custom model below.</div>`;
  }
}

document.getElementById("modelSearch").addEventListener("input", e => {
  buildModelList(e.target.value);
});

/* ---- Settings ---- */
function openSettings() {
  apiKeyInput.value = localStorage.getItem("apiKey") || "";
  selectedModel     = localStorage.getItem("model")  || "google/gemini-2.0-flash-001";
  document.getElementById("modelInput").value = "";
  document.getElementById("selectedModelDisplay").textContent = selectedModel;
  buildModelList();
  // Scroll selected model into view
  setTimeout(() => {
    const sel = document.querySelector(".model-option.selected");
    if (sel) sel.scrollIntoView({ block: "center" });
  }, 50);
  settingsModal.classList.remove("hidden");
  settingsModal.classList.add("flex");
}
function closeSettingsModal() {
  settingsModal.classList.remove("flex");
  settingsModal.classList.add("hidden");
}

document.getElementById("settingsBtn").onclick       = openSettings;
document.getElementById("settingsBtnMobile").onclick = openSettings;
document.getElementById("closeSettings").onclick     = closeSettingsModal;
document.getElementById("saveSettings").onclick = () => {
  // Custom model input overrides picker if filled in
  const custom = document.getElementById("modelInput").value.trim();
  const finalModel = custom || selectedModel;
  localStorage.setItem("apiKey", apiKeyInput.value.trim());
  localStorage.setItem("model",  finalModel);
  closeSettingsModal();
  fetchCredits(); // Refresh credits after saving new API key
};

settingsModal.addEventListener("click", e => {
  if (!settingsPanel.contains(e.target)) closeSettingsModal();
});

/* ========= API CREDITS ========= */
async function fetchCredits() {
  const apiKey = localStorage.getItem("apiKey");
  const display = document.getElementById("creditsDisplay");
  const subtext = document.getElementById("creditsSubtext");

  if (!apiKey) {
    display.textContent = "â€”";
    subtext.textContent = "Set API key to load";
    return;
  }

  display.textContent = "Loadingâ€¦";
  subtext.textContent = "";

  try {
    const res = await fetch("https://openrouter.ai/api/v1/credits", {
      headers: { "Authorization": "Bearer " + apiKey }
    });
    if (!res.ok) throw new Error("API error " + res.status);
    const data = await res.json();

    // OpenRouter returns { data: { total_credits, usage } }
    const total = data?.data?.total_credits ?? null;
    const used  = data?.data?.usage         ?? null;
    const remaining = (total !== null && used !== null) ? (total - used) : null;

    if (remaining !== null) {
      display.textContent = "$" + remaining.toFixed(4);
      subtext.textContent = `$${used.toFixed(4)} used of $${total.toFixed(4)}`;
    } else {
      display.textContent = "â€”";
      subtext.textContent = "Could not parse balance";
    }
  } catch (err) {
    display.textContent = "Error";
    subtext.textContent = err.message;
  }
}

document.getElementById("refreshCreditsBtn").addEventListener("click", fetchCredits);

// Auto-fetch credits when page loads if API key exists
window.addEventListener("load", () => {
  if (localStorage.getItem("apiKey")) fetchCredits();
});

/* ========= PWA â€” FIX 1: wait for load event ========= */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("sw.js").then(reg => reg.update()).catch(() => {});
  });
}
</script>
</body>
</html>
