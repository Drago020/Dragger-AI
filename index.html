<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dragger AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0a0a0f" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet" />

  <style>
    :root {
      --accent:     #7c6ef7;
      --accent-dim: rgba(124,110,247,0.18);
      --accent-glow:rgba(124,110,247,0.35);
      --surface:    rgba(255,255,255,0.04);
      --surface-2:  rgba(255,255,255,0.07);
      --border:     rgba(255,255,255,0.08);
      --border-2:   rgba(255,255,255,0.13);
      --text-muted: #6b7280;
      --text-dim:   #9ca3af;
    }
    * { box-sizing: border-box; }
    html, body { margin:0; padding:0; font-family:'DM Sans',sans-serif; background:#07070d; color:#e8e6f0; height:100%; overflow:hidden; }

    ::-webkit-scrollbar { width:4px; }
    ::-webkit-scrollbar-track { background:transparent; }
    ::-webkit-scrollbar-thumb { background:rgba(124,110,247,0.3); border-radius:99px; }

    .glass {
      background: rgba(255,255,255,0.06);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      border: 1px solid rgba(255,255,255,0.10);
    }
    .glass-strong {
      background: rgba(255,255,255,0.09);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      border: 1px solid rgba(255,255,255,0.14);
    }

    .app-bg { background-image:url("wallpaper.jpeg"); background-size:cover; background-position:center; position:fixed; inset:0; z-index:0; }
    .app-overlay { position:fixed; inset:0; z-index:0; background:linear-gradient(135deg,rgba(7,7,20,0.92) 0%,rgba(10,8,25,0.88) 100%); }
    .app-root { position:relative; z-index:1; height:100dvh; display:flex; overflow:hidden; }

    /* Sidebar */
    #sidebar { width:260px; min-width:260px; display:flex; flex-direction:column; border-right:1px solid var(--border); background:rgba(5,5,15,0.75); backdrop-filter:blur(24px); -webkit-backdrop-filter:blur(24px); transition:transform 0.3s cubic-bezier(0.4,0,0.2,1); z-index:40; }
    @media(max-width:767px){ #sidebar { position:fixed; top:0; left:0; height:100%; transform:translateX(-100%); } #sidebar.open { transform:translateX(0); } }

    .sidebar-logo { font-family:'Syne',sans-serif; font-weight:800; font-size:1.05rem; letter-spacing:-0.02em; background:linear-gradient(135deg,#a78bfa,#7c6ef7,#60a5fa); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }

    .new-chat-btn { width:30px; height:30px; border-radius:8px; background:var(--accent-dim); border:1px solid var(--accent-glow); color:#a78bfa; font-size:1.1rem; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:all 0.18s; }
    .new-chat-btn:hover { background:var(--accent-glow); color:#fff; box-shadow:0 0 12px var(--accent-glow); }

    .chat-item-wrap { position:relative; display:flex; align-items:center; border-radius:10px; transition:background 0.15s; }
    .chat-item-wrap:hover { background:var(--surface-2); }
    .chat-item-wrap.active-wrap { background:linear-gradient(90deg,rgba(124,110,247,0.15),transparent); border-left:2px solid var(--accent); }

    .chat-item { flex:1; text-align:left; padding:8px 10px; border-radius:10px; font-size:0.8rem; color:var(--text-dim); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; cursor:pointer; background:none; border:none; transition:color 0.15s; padding-right:28px; font-family:'DM Sans',sans-serif; }
    .chat-item:hover { color:#e8e6f0; }
    .chat-item.active { color:#c4b5fd; font-weight:500; }

    .delete-chat-btn { position:absolute; right:6px; opacity:0; background:none; border:none; color:#4b5563; font-size:0.7rem; cursor:pointer; padding:4px; border-radius:4px; transition:opacity 0.15s,color 0.15s; }
    .chat-item-wrap:hover .delete-chat-btn { opacity:1; }
    .delete-chat-btn:hover { color:#f87171; }

    .credits-box { margin:0 12px 8px; border-radius:12px; background:rgba(124,110,247,0.08); backdrop-filter:blur(16px); -webkit-backdrop-filter:blur(16px); border:1px solid rgba(124,110,247,0.22); padding:10px 12px; box-shadow:inset 0 1px 0 rgba(255,255,255,0.06); }
    .credits-label { font-size:0.63rem; text-transform:uppercase; letter-spacing:0.1em; color:var(--text-muted); font-weight:600; }
    .credits-amount { font-family:'Syne',sans-serif; font-size:1.1rem; font-weight:700; color:#a78bfa; }
    .credits-sub { font-size:0.68rem; color:var(--text-muted); }
    .refresh-btn { background:none; border:none; color:var(--text-muted); cursor:pointer; font-size:0.85rem; padding:2px 4px; border-radius:4px; transition:color 0.15s,transform 0.3s; }
    .refresh-btn:hover { color:#a78bfa; transform:rotate(180deg); }

    .about-section { margin:0 12px 8px; border-radius:12px; background:rgba(255,255,255,0.04); backdrop-filter:blur(14px); -webkit-backdrop-filter:blur(14px); border:1px solid rgba(255,255,255,0.09); overflow:hidden; }
    .about-section summary { padding:8px 12px; font-size:0.75rem; color:var(--text-muted); cursor:pointer; list-style:none; display:flex; align-items:center; gap:6px; transition:color 0.15s; user-select:none; }
    .about-section summary:hover { color:var(--text-dim); }
    .about-section summary::-webkit-details-marker { display:none; }
    .about-inner { padding:0 12px 12px; font-size:0.72rem; color:var(--text-muted); line-height:1.6; }
    .about-row { display:flex; justify-content:space-between; padding:3px 0; border-bottom:1px solid var(--border); }
    .about-row:last-child { border-bottom:none; }
    .about-row span:last-child { color:#c4b5fd; }

    .settings-btn { margin:0 12px 12px; padding:9px 12px; border-radius:10px; background:rgba(255,255,255,0.05); backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px); border:1px solid rgba(255,255,255,0.09); color:var(--text-dim); font-size:0.8rem; font-family:'DM Sans',sans-serif; cursor:pointer; display:flex; align-items:center; gap:8px; transition:all 0.18s; width:calc(100% - 24px); }
    .settings-btn:hover { background:var(--surface-2); border-color:var(--border-2); color:#e8e6f0; }

    .mobile-header { display:none; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid var(--border); background:rgba(5,5,15,0.8); backdrop-filter:blur(20px); }
    @media(max-width:767px){ .mobile-header { display:flex; } }

    .mobile-icon-btn { background:none; border:none; color:var(--text-dim); font-size:1rem; cursor:pointer; padding:6px; border-radius:8px; transition:all 0.15s; display:flex; align-items:center; }
    .mobile-icon-btn:hover { color:#e8e6f0; background:var(--surface-2); }

    #chatArea { flex:1; overflow-y:auto; padding:20px 16px; display:flex; flex-direction:column; gap:14px; }

    .msg-row { display:flex; align-items:flex-end; gap:8px; }
    .msg-row.user { flex-direction:row-reverse; }

    .avatar { width:28px; height:28px; border-radius:50%; flex-shrink:0; display:flex; align-items:center; justify-content:center; font-size:0.7rem; font-weight:700; font-family:'Syne',sans-serif; }
    .avatar-ai { background:linear-gradient(135deg,#7c6ef7,#60a5fa); color:#fff; box-shadow:0 0 10px rgba(124,110,247,0.4); }
    .avatar-user { background:rgba(255,255,255,0.08); color:var(--text-dim); border:1px solid var(--border-2); }

    .bubble { max-width:min(78%,600px); padding:10px 14px; border-radius:18px; font-size:0.875rem; line-height:1.65; animation:bubbleIn 0.2s cubic-bezier(0.34,1.56,0.64,1) both; }
    @keyframes bubbleIn { from { opacity:0; transform:scale(0.92) translateY(6px); } to { opacity:1; transform:scale(1) translateY(0); } }

    .bubble-ai { background:rgba(255,255,255,0.07); backdrop-filter:blur(16px); -webkit-backdrop-filter:blur(16px); border:1px solid rgba(255,255,255,0.11); border-bottom-left-radius:4px; color:#ddd8f0; }
    .bubble-user { background:linear-gradient(135deg,rgba(109,92,231,0.85),rgba(124,110,247,0.9)); backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px); border:1px solid rgba(167,139,250,0.3); border-bottom-right-radius:4px; color:#fff; box-shadow:0 4px 20px rgba(124,110,247,0.3); }

    .bubble-ai p { margin:0 0 0.5em; }
    .bubble-ai p:last-child { margin-bottom:0; }
    .bubble-ai ul,.bubble-ai ol { padding-left:1.3em; margin:0.4em 0; }
    .bubble-ai li { margin-bottom:0.2em; }
    .bubble-ai code { background:rgba(124,110,247,0.15); color:#c4b5fd; padding:0.1em 0.45em; border-radius:5px; font-size:0.82em; font-family:monospace; border:1px solid rgba(124,110,247,0.2); }
    .bubble-ai pre { background:rgba(0,0,0,0.45); border:1px solid var(--border-2); border-radius:10px; padding:12px 14px; overflow-x:auto; margin:8px 0; }
    .bubble-ai pre code { background:none; border:none; padding:0; font-size:0.8em; color:#c4b5fd; }
    .bubble-ai strong { color:#c4b5fd; font-weight:600; }
    .bubble-ai em { color:#a5b4fc; }
    .bubble-ai h1,.bubble-ai h2,.bubble-ai h3 { font-family:'Syne',sans-serif; font-weight:700; color:#e0e7ff; margin:0.6em 0 0.3em; }
    .bubble-ai blockquote { border-left:3px solid var(--accent); padding-left:12px; margin:8px 0; color:var(--text-dim); font-style:italic; }

    .typing-dots { display:inline-flex; gap:5px; align-items:center; padding:2px 0; }
    .typing-dots span { width:6px; height:6px; border-radius:50%; background:#7c6ef7; animation:typingBlink 1.3s infinite; }
    .typing-dots span:nth-child(2) { animation-delay:0.18s; }
    .typing-dots span:nth-child(3) { animation-delay:0.36s; }
    @keyframes typingBlink { 0%,80%,100% { opacity:0.25; transform:scale(0.75); } 40% { opacity:1; transform:scale(1); } }

    .input-bar { padding:12px 16px; border-top:1px solid var(--border); background:rgba(5,5,15,0.7); backdrop-filter:blur(20px); display:flex; align-items:center; gap:10px; }
    .input-wrap { flex:1; display:flex; align-items:center; background:rgba(255,255,255,0.07); backdrop-filter:blur(16px); -webkit-backdrop-filter:blur(16px); border:1px solid rgba(255,255,255,0.12); border-radius:14px; padding:0 14px; transition:border-color 0.2s,box-shadow 0.2s; }
    .input-wrap:focus-within { border-color:rgba(124,110,247,0.5); box-shadow:0 0 0 3px rgba(124,110,247,0.1); }
    #userInput { flex:1; background:none; border:none; outline:none; color:#e8e6f0; font-family:'DM Sans',sans-serif; font-size:0.9rem; padding:11px 0; }
    #userInput::placeholder { color:#374151; }

    .send-btn { width:40px; height:40px; border-radius:12px; background:linear-gradient(135deg,#7c6ef7,#6d5ce7); border:none; color:#fff; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.18s; flex-shrink:0; box-shadow:0 4px 14px rgba(124,110,247,0.35); }
    .send-btn:hover:not(:disabled) { transform:scale(1.06); box-shadow:0 6px 20px rgba(124,110,247,0.5); }
    .send-btn:disabled { opacity:0.4; cursor:not-allowed; transform:none; box-shadow:none; }

    #sidebarOverlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:39; }
    #sidebarOverlay.show { display:block; }

    #settingsModal { position:fixed; inset:0; background:rgba(0,0,0,0.7); backdrop-filter:blur(8px); z-index:50; display:none; align-items:center; justify-content:center; padding:16px; }
    #settingsModal.open { display:flex; }
    #settingsPanel { background:rgba(14,13,26,0.82); backdrop-filter:blur(32px); -webkit-backdrop-filter:blur(32px); border:1px solid rgba(255,255,255,0.12); border-radius:20px; width:100%; max-width:420px; max-height:88dvh; overflow-y:auto; padding:24px; box-shadow:0 24px 60px rgba(0,0,0,0.6),0 0 0 1px rgba(124,110,247,0.12); animation:modalIn 0.22s cubic-bezier(0.34,1.3,0.64,1) both; }
    @keyframes modalIn { from { opacity:0; transform:scale(0.93) translateY(10px); } to { opacity:1; transform:scale(1) translateY(0); } }

    .modal-title { font-family:'Syne',sans-serif; font-size:1.2rem; font-weight:800; color:#e8e6f0; margin-bottom:20px; display:flex; align-items:center; gap:8px; }
    .field-label { font-size:0.7rem; font-weight:600; text-transform:uppercase; letter-spacing:0.08em; color:var(--text-muted); margin-bottom:6px; display:block; }
    .field-input { width:100%; background:rgba(255,255,255,0.05); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,0.10); border-radius:10px; padding:10px 13px; color:#e8e6f0; font-family:'DM Sans',sans-serif; font-size:0.88rem; outline:none; transition:border-color 0.18s,box-shadow 0.18s; }
    .field-input:focus { border-color:rgba(124,110,247,0.5); box-shadow:0 0 0 3px rgba(124,110,247,0.1); }
    .field-input::placeholder { color:#374151; }
    .field-group { margin-bottom:18px; }
    .modal-divider { border:none; border-top:1px solid var(--border); margin:18px 0; }

    #modelSearch { margin-bottom:8px; }
    #modelList { background:rgba(0,0,0,0.25); backdrop-filter:blur(16px); -webkit-backdrop-filter:blur(16px); border:1px solid rgba(255,255,255,0.09); border-radius:10px; max-height:200px; overflow-y:auto; }
    .model-group-label { padding:7px 12px 3px; font-size:0.6rem; text-transform:uppercase; letter-spacing:0.1em; color:#7c6ef7; font-weight:700; }
    .model-option { padding:8px 12px; cursor:pointer; border-left:2px solid transparent; transition:background 0.12s; }
    .model-option:hover { background:var(--accent-dim); }
    .model-option.selected { background:rgba(124,110,247,0.12); border-left-color:#7c6ef7; }
    .model-name { font-size:0.82rem; font-weight:500; color:#e0e7ff; }
    .model-id { font-size:0.68rem; color:#6b7280; font-family:monospace; }
    .model-tag { font-size:0.58rem; padding:1px 6px; border-radius:99px; display:inline-block; margin-top:2px; font-weight:700; }
    .tag-free { background:rgba(34,197,94,0.15); color:#86efac; border:1px solid rgba(34,197,94,0.25); }
    .tag-fast { background:rgba(251,191,36,0.15); color:#fde68a; border:1px solid rgba(251,191,36,0.25); }
    .tag-powerful { background:rgba(124,110,247,0.15); color:#c4b5fd; border:1px solid rgba(124,110,247,0.25); }

    .selected-model-chip { display:flex; align-items:center; gap:6px; margin-top:8px; padding:5px 10px; background:var(--accent-dim); border:1px solid rgba(124,110,247,0.25); border-radius:99px; font-size:0.7rem; font-family:monospace; color:#a78bfa; }
    .custom-model-toggle { font-size:0.72rem; color:var(--text-muted); cursor:pointer; margin-top:8px; display:block; }
    .custom-model-toggle:hover { color:var(--text-dim); }

    .modal-btn-row { display:flex; gap:10px; justify-content:flex-end; margin-top:4px; }
    .btn-cancel { padding:9px 18px; border-radius:10px; background:var(--surface); border:1px solid var(--border-2); color:var(--text-dim); font-family:'DM Sans',sans-serif; font-size:0.85rem; cursor:pointer; transition:all 0.15s; }
    .btn-cancel:hover { background:var(--surface-2); color:#e8e6f0; }
    .btn-save { padding:9px 22px; border-radius:10px; background:linear-gradient(135deg,#7c6ef7,#6d5ce7); border:none; color:#fff; font-family:'DM Sans',sans-serif; font-size:0.85rem; font-weight:600; cursor:pointer; transition:all 0.18s; box-shadow:0 4px 14px rgba(124,110,247,0.3); }
    .btn-save:hover { box-shadow:0 6px 20px rgba(124,110,247,0.5); transform:translateY(-1px); }

    .empty-state { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px; text-align:center; padding:40px; }
    .empty-logo { font-family:'Syne',sans-serif; font-size:2rem; font-weight:800; background:linear-gradient(135deg,#a78bfa,#7c6ef7,#60a5fa); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
    .empty-sub { font-size:0.82rem; color:#374151; }
    .suggestion-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:4px; width:100%; max-width:400px; }
    .suggestion-chip { padding:10px 12px; background:rgba(255,255,255,0.05); backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px); border:1px solid rgba(255,255,255,0.09); border-radius:12px; font-size:0.78rem; color:var(--text-dim); cursor:pointer; text-align:left; transition:all 0.18s; font-family:'DM Sans',sans-serif; }
    .suggestion-chip:hover { background:var(--accent-dim); border-color:rgba(124,110,247,0.3); color:#c4b5fd; }

    #activeModelBadge { font-size:0.68rem; padding:3px 10px; background:var(--accent-dim); border:1px solid rgba(124,110,247,0.2); border-radius:99px; color:#a78bfa; font-family:monospace; max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  </style>
</head>

<body>
<div class="app-bg"></div>
<div class="app-overlay"></div>
<div class="app-root">

  <div id="sidebarOverlay"></div>

  <!-- ══ SIDEBAR ══ -->
  <aside id="sidebar">
    <div style="padding:16px 14px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;">
      <span class="sidebar-logo">Dragger AI</span>
      <button class="new-chat-btn" id="newChatBtn" title="New chat">+</button>
    </div>

    <div id="chatList" style="flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;gap:2px;"></div>

    <div class="credits-box">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
        <span class="credits-label">OpenRouter Credits</span>
        <button class="refresh-btn" id="refreshCreditsBtn" title="Refresh">↻</button>
      </div>
      <div class="credits-amount" id="creditsDisplay">—</div>
      <div class="credits-sub" id="creditsSubtext">Set API key to load</div>
    </div>

    <details class="about-section">
      <summary><span style="opacity:0.5;">ℹ</span> About &amp; Credits</summary>
      <div class="about-inner">
        <div style="margin-bottom:8px;"><span style="color:#c4b5fd;font-family:'Syne',sans-serif;font-weight:700;">Dragger AI</span> <span style="color:var(--text-muted);">v1.0</span></div>
        <p style="margin-bottom:8px;">A PWA AI chat powered by <a href="https://openrouter.ai" target="_blank" style="color:#a78bfa;">OpenRouter</a> — access dozens of models in one place.</p>
        <div>
          <div class="about-row"><span>Made by</span><span>Dragger</span></div>
          <div class="about-row"><span>UI</span><span>Tailwind + DM Sans</span></div>
          <div class="about-row"><span>Markdown</span><span>marked.js</span></div>
          <div class="about-row"><span>Models via</span><span>OpenRouter</span></div>
        </div>
        <p style="margin-top:8px;color:var(--text-muted);">API key &amp; chats stored locally only.</p>
      </div>
    </details>

    <button class="settings-btn" id="settingsBtn">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      Settings
    </button>
  </aside>

  <!-- ══ MAIN ══ -->
  <main style="flex:1;display:flex;flex-direction:column;min-height:0;overflow:hidden;">

    <!-- Mobile header -->
    <div class="mobile-header">
      <button class="mobile-icon-btn" id="menuBtn">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      </button>
      <span style="font-family:'Syne',sans-serif;font-weight:800;font-size:0.95rem;background:linear-gradient(135deg,#a78bfa,#7c6ef7);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">Dragger AI</span>
      <button class="mobile-icon-btn" id="settingsBtnMobile">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      </button>
    </div>

    <!-- Desktop model bar -->
    <div id="desktopBar" style="padding:7px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;background:rgba(5,5,15,0.5);">
      <span style="font-size:0.68rem;color:var(--text-muted);">Model</span>
      <span id="activeModelBadge">—</span>
    </div>

    <div id="chatArea"></div>

    <div class="input-bar">
      <div class="input-wrap">
        <input id="userInput" type="text" placeholder="Ask anything…" maxlength="4000" autocomplete="off" />
      </div>
      <button class="send-btn" id="sendBtn" title="Send">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
      </button>
    </div>
  </main>

  <!-- ══ SETTINGS MODAL ══ -->
  <div id="settingsModal">
    <div id="settingsPanel">
      <div class="modal-title">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#7c6ef7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        Settings
      </div>

      <div class="field-group">
        <label class="field-label">OpenRouter API Key</label>
        <input id="apiKeyInput" type="password" class="field-input" placeholder="sk-or-..." />
      </div>

      <hr class="modal-divider" />

      <div class="field-group">
        <label class="field-label">AI Model</label>
        <input id="modelSearch" type="text" class="field-input" placeholder="Search models…" />
        <div id="modelList"></div>
        <div class="selected-model-chip"><span style="opacity:0.5;">✓</span><span id="selectedModelDisplay">—</span></div>
        <details style="margin-top:10px;">
          <summary class="custom-model-toggle">Use a custom model ID instead</summary>
          <input id="modelInput" type="text" class="field-input" style="margin-top:6px;" placeholder="e.g. mistralai/mistral-7b-instruct" />
        </details>
      </div>

      <div class="modal-btn-row">
        <button class="btn-cancel" id="closeSettings">Cancel</button>
        <button class="btn-save" id="saveSettings">Save changes</button>
      </div>
    </div>
  </div>

</div>

<script>
marked.setOptions({ breaks:true, gfm:true });

const chatArea       = document.getElementById("chatArea");
const chatList       = document.getElementById("chatList");
const userInput      = document.getElementById("userInput");
const sendBtn        = document.getElementById("sendBtn");
const menuBtn        = document.getElementById("menuBtn");
const sidebar        = document.getElementById("sidebar");
const sidebarOverlay = document.getElementById("sidebarOverlay");
const settingsModal  = document.getElementById("settingsModal");
const settingsPanel  = document.getElementById("settingsPanel");
const apiKeyInput    = document.getElementById("apiKeyInput");

let chats        = JSON.parse(localStorage.getItem("chats") || "{}");
let activeChatId = localStorage.getItem("activeChatId");
let isStreaming   = false;

if (!activeChatId || !chats[activeChatId]) { createNewChat(); }
else { renderChats(); renderMessages(); }
updateModelBadge();

function saveChats() {
  localStorage.setItem("chats", JSON.stringify(chats));
  localStorage.setItem("activeChatId", activeChatId);
}
function escapeHtml(t) {
  return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;").replace(/\n/g,"<br>");
}
function openSidebar()  { sidebar.classList.add("open");    sidebarOverlay.classList.add("show"); }
function closeSidebar() { sidebar.classList.remove("open"); sidebarOverlay.classList.remove("show"); }
function updateModelBadge() {
  const m = localStorage.getItem("model") || "google/gemini-2.0-flash-001";
  const el = document.getElementById("activeModelBadge");
  if (el) el.textContent = m;
}

function createNewChat() {
  const id = Date.now().toString();
  chats[id] = [];
  activeChatId = id;
  saveChats(); renderChats(); showEmptyState();
}
function switchChat(id) { activeChatId=id; saveChats(); renderChats(); renderMessages(); closeSidebar(); }
function deleteChat(id) {
  delete chats[id];
  if (activeChatId === id) {
    const rem = Object.keys(chats);
    if (rem.length > 0) { activeChatId = rem[rem.length-1]; } else { createNewChat(); return; }
  }
  saveChats(); renderChats(); renderMessages();
}
function renderChats() {
  chatList.innerHTML = "";
  Object.keys(chats).sort((a,b)=>b-a).forEach(id => {
    const wrap = document.createElement("div");
    wrap.className = "chat-item-wrap" + (id===activeChatId?" active-wrap":"");
    const btn = document.createElement("button");
    btn.className = "chat-item" + (id===activeChatId?" active":"");
    const fu = chats[id].find(m=>m.role==="user");
    btn.textContent = fu ? fu.content.slice(0,32)+(fu.content.length>32?"…":"") : "New Chat";
    btn.title = btn.textContent;
    btn.onclick = ()=>switchChat(id);
    const del = document.createElement("button");
    del.className = "delete-chat-btn"; del.textContent="✕"; del.title="Delete";
    del.onclick = e=>{ e.stopPropagation(); deleteChat(id); };
    wrap.appendChild(btn); wrap.appendChild(del); chatList.appendChild(wrap);
  });
}

function showEmptyState() {
  chatArea.innerHTML = "";
  const suggestions = ["Explain quantum computing simply","Write a Python web scraper","Help me plan a trip to Japan","What's the best way to learn a language?"];
  chatArea.innerHTML = `<div class="empty-state">
    <div class="empty-logo">Dragger AI</div>
    <p class="empty-sub">Powered by OpenRouter · Choose any model in Settings</p>
    <div class="suggestion-grid">${suggestions.map(s=>`<button class="suggestion-chip" onclick="useSuggestion('${s.replace(/'/g,"\\'")}'">${s}</button>`).join("")}</div>
  </div>`;
}
function useSuggestion(t) { userInput.value=t; userInput.focus(); }

function renderMessages() {
  chatArea.innerHTML="";
  if (!chats[activeChatId]||chats[activeChatId].length===0) { showEmptyState(); return; }
  chats[activeChatId].forEach(msg=>appendMessageEl(msg.role,msg.content));
  chatArea.scrollTop=chatArea.scrollHeight;
}
function appendMessageEl(role,content) {
  const row=document.createElement("div"); row.className="msg-row "+(role==="user"?"user":"ai");
  const av=document.createElement("div"); av.className="avatar "+(role==="user"?"avatar-user":"avatar-ai"); av.textContent=role==="user"?"U":"AI";
  const bub=document.createElement("div"); bub.className="bubble "+(role==="user"?"bubble-user":"bubble-ai");
  bub.innerHTML=role==="assistant"?marked.parse(content):escapeHtml(content);
  row.appendChild(av); row.appendChild(bub); chatArea.appendChild(row); return row;
}
function showTypingIndicator() {
  const row=document.createElement("div"); row.className="msg-row ai"; row.id="typingIndicator";
  row.innerHTML=`<div class="avatar avatar-ai">AI</div><div class="bubble bubble-ai"><div class="typing-dots"><span></span><span></span><span></span></div></div>`;
  chatArea.appendChild(row); chatArea.scrollTop=chatArea.scrollHeight;
}
function removeTypingIndicator() { document.getElementById("typingIndicator")?.remove(); }

async function typeAssistantMessage(text) {
  const msg={role:"assistant",content:""};
  chats[activeChatId].push(msg);
  const row=document.createElement("div"); row.className="msg-row ai";
  const av=document.createElement("div"); av.className="avatar avatar-ai"; av.textContent="AI";
  const bub=document.createElement("div"); bub.className="bubble bubble-ai";
  row.appendChild(av); row.appendChild(bub); chatArea.appendChild(row);
  for (const char of text) {
    msg.content+=char; bub.innerHTML=marked.parse(msg.content);
    chatArea.scrollTop=chatArea.scrollHeight;
    await new Promise(r=>setTimeout(r,13));
  }
  saveChats();
}

function setInputLocked(locked) { isStreaming=locked; sendBtn.disabled=locked; userInput.disabled=locked; }

async function sendMessage() {
  const content=userInput.value.trim();
  if (!content||isStreaming) return;
  userInput.value=""; setInputLocked(true); closeSidebar();
  if (chatArea.querySelector(".empty-state")) chatArea.innerHTML="";
  chats[activeChatId].push({role:"user",content});
  appendMessageEl("user",content);
  chatArea.scrollTop=chatArea.scrollHeight;
  renderChats(); saveChats();
  const apiKey=localStorage.getItem("apiKey");
  const model=localStorage.getItem("model")||"google/gemini-2.0-flash-001";
  if (!apiKey) { await typeAssistantMessage("⚠️ Please set your OpenRouter API key in Settings."); setInputLocked(false); return; }
  showTypingIndicator();
  try {
    const res=await fetch("https://openrouter.ai/api/v1/chat/completions",{
      method:"POST",
      headers:{"Content-Type":"application/json","Authorization":"Bearer "+apiKey},
      body:JSON.stringify({model,messages:chats[activeChatId].map(({role,content})=>({role,content}))})
    });
    removeTypingIndicator();
    if (!res.ok) { const err=await res.json().catch(()=>({})); await typeAssistantMessage("⚠️ "+(err?.error?.message||`API error ${res.status}`)); }
    else { const data=await res.json(); await typeAssistantMessage(data.choices?.[0]?.message?.content||"⚠️ No response."); }
  } catch(err) { removeTypingIndicator(); await typeAssistantMessage(`⚠️ Network error: ${err.message}`); }
  finally { setInputLocked(false); userInput.focus(); }
}

menuBtn.addEventListener("click",()=>sidebar.classList.contains("open")?closeSidebar():openSidebar());
sidebarOverlay.addEventListener("click",closeSidebar);
document.getElementById("newChatBtn").onclick=()=>{createNewChat();closeSidebar();};
userInput.addEventListener("keydown",e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();sendMessage();}});
sendBtn.addEventListener("click",sendMessage);

// Hide desktop bar on mobile
const deskBar=document.getElementById("desktopBar");
function updateDeskBar(){if(deskBar)deskBar.style.display=window.innerWidth>=768?"flex":"none";}
updateDeskBar(); window.addEventListener("resize",updateDeskBar);

const MODELS=[
  {group:"Google",models:[{name:"Gemini 2.0 Flash",id:"google/gemini-2.0-flash-001",tags:["fast"]},{name:"Gemini 2.5 Pro",id:"google/gemini-2.5-pro-preview-03-25",tags:["powerful"]},{name:"Gemini Flash 1.5 8B",id:"google/gemini-flash-1.5-8b",tags:["free","fast"]}]},
  {group:"OpenAI",models:[{name:"GPT-4o",id:"openai/gpt-4o",tags:["powerful"]},{name:"GPT-4o Mini",id:"openai/gpt-4o-mini",tags:["fast"]},{name:"o3 Mini",id:"openai/o3-mini",tags:["powerful"]}]},
  {group:"Anthropic",models:[{name:"Claude 3.5 Sonnet",id:"anthropic/claude-3-5-sonnet",tags:["powerful"]},{name:"Claude 3.5 Haiku",id:"anthropic/claude-3-5-haiku",tags:["fast"]},{name:"Claude 3 Opus",id:"anthropic/claude-3-opus",tags:["powerful"]}]},
  {group:"Meta",models:[{name:"Llama 3.3 70B",id:"meta-llama/llama-3.3-70b-instruct",tags:["free","fast"]},{name:"Llama 3.1 8B",id:"meta-llama/llama-3.1-8b-instruct",tags:["free","fast"]},{name:"Llama 4 Maverick",id:"meta-llama/llama-4-maverick",tags:["powerful"]}]},
  {group:"Mistral",models:[{name:"Mistral 7B",id:"mistralai/mistral-7b-instruct",tags:["free","fast"]},{name:"Mixtral 8x7B",id:"mistralai/mixtral-8x7b-instruct",tags:["fast"]},{name:"Mistral Large",id:"mistralai/mistral-large",tags:["powerful"]}]},
  {group:"DeepSeek",models:[{name:"DeepSeek Chat V3",id:"deepseek/deepseek-chat-v3-0324",tags:["powerful"]},{name:"DeepSeek R1",id:"deepseek/deepseek-r1",tags:["powerful"]},{name:"DeepSeek R1 Free",id:"deepseek/deepseek-r1:free",tags:["free"]}]},
  {group:"xAI",models:[{name:"Grok 3",id:"x-ai/grok-3",tags:["powerful"]},{name:"Grok 3 Mini",id:"x-ai/grok-3-mini",tags:["fast"]}]},
];

let selectedModel=localStorage.getItem("model")||"google/gemini-2.0-flash-001";

function buildModelList(filter=""){
  const list=document.getElementById("modelList"); list.innerHTML="";
  const q=filter.toLowerCase();
  MODELS.forEach(group=>{
    const filtered=group.models.filter(m=>m.name.toLowerCase().includes(q)||m.id.toLowerCase().includes(q));
    if(!filtered.length)return;
    const lbl=document.createElement("div"); lbl.className="model-group-label"; lbl.textContent=group.group; list.appendChild(lbl);
    filtered.forEach(m=>{
      const el=document.createElement("div"); el.className="model-option"+(m.id===selectedModel?" selected":"");
      el.innerHTML=`<div class="model-name">${m.name}</div><div class="model-id">${m.id}</div><div>${m.tags.map(t=>`<span class="model-tag tag-${t}">${t}</span>`).join(" ")}</div>`;
      el.onclick=()=>{ selectedModel=m.id; document.getElementById("modelInput").value=""; document.getElementById("selectedModelDisplay").textContent=m.id; buildModelList(document.getElementById("modelSearch").value); };
      list.appendChild(el);
    });
  });
  if(!list.children.length) list.innerHTML=`<div style="padding:12px;font-size:0.8rem;color:var(--text-muted);text-align:center;">No models found — use custom ID below</div>`;
}
document.getElementById("modelSearch").addEventListener("input",e=>buildModelList(e.target.value));

function openSettings(){
  apiKeyInput.value=localStorage.getItem("apiKey")||"";
  selectedModel=localStorage.getItem("model")||"google/gemini-2.0-flash-001";
  document.getElementById("modelInput").value="";
  document.getElementById("selectedModelDisplay").textContent=selectedModel;
  buildModelList();
  setTimeout(()=>{ const s=document.querySelector(".model-option.selected"); if(s)s.scrollIntoView({block:"center"}); },50);
  settingsModal.classList.add("open");
}
function closeSettingsModal(){ settingsModal.classList.remove("open"); }

document.getElementById("settingsBtn").onclick=openSettings;
document.getElementById("settingsBtnMobile").onclick=openSettings;
document.getElementById("closeSettings").onclick=closeSettingsModal;
document.getElementById("saveSettings").onclick=()=>{
  const custom=document.getElementById("modelInput").value.trim();
  const finalModel=custom||selectedModel;
  localStorage.setItem("apiKey",apiKeyInput.value.trim());
  localStorage.setItem("model",finalModel);
  closeSettingsModal(); updateModelBadge(); fetchCredits();
};
settingsModal.addEventListener("click",e=>{ if(!settingsPanel.contains(e.target))closeSettingsModal(); });

async function fetchCredits(){
  const apiKey=localStorage.getItem("apiKey");
  const display=document.getElementById("creditsDisplay");
  const subtext=document.getElementById("creditsSubtext");
  if(!apiKey){display.textContent="—";subtext.textContent="Set API key to load";return;}
  display.textContent="Loading…"; subtext.textContent="";
  try {
    const res=await fetch("https://openrouter.ai/api/v1/credits",{headers:{"Authorization":"Bearer "+apiKey}});
    if(!res.ok)throw new Error("Error "+res.status);
    const data=await res.json();
    const total=data?.data?.total_credits??null, used=data?.data?.usage??null;
    const remaining=(total!==null&&used!==null)?total-used:null;
    if(remaining!==null){display.textContent="$"+remaining.toFixed(4);subtext.textContent=`$${used.toFixed(4)} used · $${total.toFixed(4)} total`;}
    else{display.textContent="—";subtext.textContent="Could not read balance";}
  } catch(err){display.textContent="Error";subtext.textContent=err.message;}
}
document.getElementById("refreshCreditsBtn").addEventListener("click",fetchCredits);

window.addEventListener("load",()=>{
  if(localStorage.getItem("apiKey"))fetchCredits();
  if("serviceWorker"in navigator) navigator.serviceWorker.register("sw.js").then(r=>r.update()).catch(()=>{});
});
</script>
</body>
</html>
