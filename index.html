<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dragger AI Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-thumb { background: #555; border-radius: 6px; }

    .app-bg {
      background-image: url("wallpaper.jpeg");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }

    .app-overlay {
      background: rgba(0, 0, 0, 0.65);
    }

    .glass {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border: 1px solid rgba(255, 255, 255, 0.12);
    }
  </style>
</head>

<body class="text-gray-100 app-bg">

<div class="h-[100dvh] flex overflow-x-hidden app-overlay">

  <!-- Sidebar -->
  <aside id="sidebar"
    class="fixed md:static top-0 left-0 h-full w-64 glass flex flex-col z-40
           -translate-x-full md:translate-x-0 transition-transform duration-300">

    <div class="p-4 border-b border-white/10 flex justify-between items-center">
      <span class="font-bold">Dragger AI</span>
      <button id="newChatBtn" class="bg-indigo-600 px-2 py-1 rounded">+</button>
    </div>

    <div id="chatList" class="flex-1 overflow-y-auto p-2 space-y-1"></div>

    <button id="settingsBtn" class="m-3 bg-white/10 hover:bg-white/20 px-3 py-2 rounded text-sm">
      âš™ Settings
    </button>
  </aside>

  <!-- Main -->
  <main class="flex-1 flex flex-col min-h-0">

    <div class="md:hidden flex items-center justify-between px-4 py-3 border-b border-white/10 glass">
      <button id="menuBtn" class="text-xl">â˜°</button>
      <span class="font-bold">Dragger AI</span>
      <button id="settingsBtnMobile">âš™</button>
    </div>

    <div id="chatArea" class="flex-1 overflow-y-auto p-4 space-y-4"></div>

    <div class="border-t border-white/10 p-3 flex gap-2 glass">
      <input
        id="userInput"
        type="text"
        placeholder="Ask anything..."
        class="flex-1 bg-white/10 rounded-xl px-4 py-2 focus:outline-none"
      />
      <button id="sendBtn" class="bg-indigo-600 px-4 py-2 rounded-xl font-semibold">
        Send
      </button>
    </div>
  </main>

  <!-- Settings Modal -->
  <div id="settingsModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
    <div class="glass w-96 max-w-[90%] rounded-lg p-6 space-y-4">
      <h2 class="text-xl font-bold">Settings</h2>

      <div>
        <label class="text-sm">OpenRouter API Key</label>
        <input id="apiKeyInput" type="password"
          class="w-full mt-1 bg-white/10 rounded px-3 py-2" />
      </div>

      <div>
        <label class="text-sm">Model Name</label>
        <input id="modelInput" type="text"
          placeholder="google/gemini-pro"
          class="w-full mt-1 bg-white/10 rounded px-3 py-2" />
      </div>

      <div class="flex justify-end gap-2">
        <button id="closeSettings" class="px-4 py-2 bg-white/10 rounded">Cancel</button>
        <button id="saveSettings" class="px-4 py-2 bg-indigo-600 rounded">Save</button>
      </div>
    </div>
  </div>

</div>

<script>
const chatArea = document.getElementById("chatArea");
const chatList = document.getElementById("chatList");
const userInput = document.getElementById("userInput");
const menuBtn = document.getElementById("menuBtn");
const sidebar = document.getElementById("sidebar");
const settingsModal = document.getElementById("settingsModal");
const apiKeyInput = document.getElementById("apiKeyInput");
const modelInput = document.getElementById("modelInput");

let chats = JSON.parse(localStorage.getItem("chats") || "{}");
let activeChatId = localStorage.getItem("activeChatId");

function saveChats() {
  localStorage.setItem("chats", JSON.stringify(chats));
  localStorage.setItem("activeChatId", activeChatId);
}

function createChat() {
  const id = Date.now().toString();
  chats[id] = [{ role: "assistant", content: "ðŸ‘‹ Welcome! Ask me anything." }];
  activeChatId = id;
  saveChats();
  renderChats();
  renderMessages();
}

function renderChats() {
  chatList.innerHTML = "";
  Object.keys(chats).forEach(id => {
    const btn = document.createElement("button");
    btn.className = "w-full text-left px-3 py-2 rounded hover:bg-white/10 text-sm";
    btn.textContent = "Chat " + id.slice(-4);
    btn.onclick = () => {
      activeChatId = id;
      saveChats();
      renderMessages();
      sidebar.classList.add("-translate-x-full");
    };
    chatList.appendChild(btn);
  });
}

function renderMessages() {
  chatArea.innerHTML = "";
  chats[activeChatId]?.forEach(msg => {
    const div = document.createElement("div");
    div.className = msg.role === "user" ? "text-right" : "text-left";
    div.innerHTML = `
      <div class="inline-block max-w-[85%] px-4 py-2 rounded-2xl glass ${
        msg.role === "user" ? "bg-indigo-500/40" : "bg-white/10"
      }">${msg.content}</div>`;
    chatArea.appendChild(div);
  });
  chatArea.scrollTop = chatArea.scrollHeight;
}

async function typeAssistantMessage(text) {
  const msg = { role: "assistant", content: "" };
  chats[activeChatId].push(msg);
  renderMessages();

  for (let i = 0; i < text.length; i++) {
    msg.content += text[i];
    renderMessages();
    await new Promise(r => setTimeout(r, 18));
  }
  saveChats();
}

/* âœ… SAFE API VERSION */
async function sendMessage() {
  if (!userInput.value.trim()) return;

  const content = userInput.value;
  userInput.value = "";

  chats[activeChatId].push({ role: "user", content });
  renderMessages();
  saveChats();

  const apiKey = localStorage.getItem("apiKey");
  const model = localStorage.getItem("model") || "google/gemini-pro";

  if (!apiKey) {
    return typeAssistantMessage("âš ï¸ Set your API key in Settings.");
  }

  try {
    const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + apiKey
      },
      body: JSON.stringify({
        model,
        messages: chats[activeChatId]
      })
    });

    if (!res.ok) throw new Error("API Error");

    const data = await res.json();
    const reply = data.choices?.[0]?.message?.content || "No response";
    await typeAssistantMessage(reply);

  } catch (error) {
    console.error(error);
    await typeAssistantMessage("âŒ Failed to get response. Check API key or internet.");
  }
}

menuBtn?.addEventListener("click", () => {
  sidebar.classList.toggle("-translate-x-full");
});

document.getElementById("sendBtn").addEventListener("click", sendMessage);
userInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter") sendMessage();
});

function openSettings() {
  settingsModal.classList.remove("hidden");
  settingsModal.classList.add("flex");
  apiKeyInput.value = localStorage.getItem("apiKey") || "";
  modelInput.value = localStorage.getItem("model") || "";
}

document.getElementById("settingsBtn")?.addEventListener("click", openSettings);
document.getElementById("settingsBtnMobile")?.addEventListener("click", openSettings);
document.getElementById("closeSettings").onclick = () => settingsModal.classList.add("hidden");
document.getElementById("saveSettings").onclick = () => {
  localStorage.setItem("apiKey", apiKeyInput.value.trim());
  localStorage.setItem("model", modelInput.value.trim());
  settingsModal.classList.add("hidden");
};

document.getElementById("newChatBtn").onclick = createChat;

if (!activeChatId) createChat();
renderChats();
renderMessages();
</script>

</body>
</html>
